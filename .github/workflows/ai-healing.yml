name: ðŸš‘ AI Dev Team - Auto-Healing System

on:
  issues:
    types: [opened, labeled]
  repository_dispatch:
    types: [vercel_deployment_failed]
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  auto-heal:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check AI Team Issues
        id: check_issues
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ai-team'
            });
            core.setOutput('has_issues', issues.data.length > 0);
            core.setOutput('issues', JSON.stringify(issues.data));
            return issues.data.length;

      - name: Auto-Fix Issues
        if: steps.check_issues.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = JSON.parse(process.env.ISSUES);
            const fs = require('fs');

            for (const issue of issues) {
              if (issue.title.includes('MISSING')) {
                const fileName = issue.title.match(/Add (.+)/)?.[1];
                if (fileName) {
                  let content = '';
                  if (fileName === '.env.example') content = 'DATABASE_URL=\nAPI_KEY=\n';
                  else if (fileName === 'LICENSE') content = 'MIT License\n';
                  else if (fileName === 'CONTRIBUTING.md') content = '# Contributing\n';

                  if (content) {
                    try {
                      await github.rest.repos.createOrUpdateFileContents({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        path: fileName,
                        message: `AI Team: Auto-create ${fileName}`,
                        content: Buffer.from(content).toString('base64')
                      });
                      await github.rest.issues.update({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issue.number,
                        state: 'closed'
                      });
                    } catch (e) {}
                  }
                }
              }
            }
        env:
          ISSUES: ${{ steps.check_issues.outputs.issues }}
